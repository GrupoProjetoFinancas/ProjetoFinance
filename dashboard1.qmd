---
title: "Análise de Ativos"
format: dashboard
engine: knitr
orientation: columns
vertical_layout: fill
---

```{r}
#| include: false
library(tidyquant)
library(ggplot2)
library(dplyr)
library(tidyr)
library(lubridate)
library(rugarch)
library(forecast)

# Configurações gerais
options(scipen = 999)
theme_set(theme_minimal())

# Download e preparação dos dados
tickers <- c("SAP", "ORCL", "CRM", "NOW", "IBM")
data <- tq_get(tickers, from = Sys.Date() - years(5), to = Sys.Date())

portfolio_prices <- data %>% 
  mutate(date = ymd(date)) %>% 
  select(date, symbol, adjusted) %>% 
  spread(symbol, adjusted) %>% 
  na.omit()

# Cálculo dos log-retornos
log_returns <- portfolio_prices %>% 
  mutate(across(-date, ~ log(.) - log(lag(.)))) %>% 
  drop_na()

log_returns_long <- log_returns %>% 
  pivot_longer(-date, names_to = "Ativo", values_to = "Log_Retorno")

# Lista para armazenar gráficos
plots_log <- list()
plots_vol <- list()

# Gerar gráficos de log-retornos
for (ticker in tickers) {
  plots_log[[ticker]] <- ggplot(filter(log_returns_long, Ativo == ticker), 
                              aes(x = date, y = Log_Retorno)) +
    geom_line(color = "steelblue", linewidth = 0.8) +
    labs(title = paste("Log-Retornos -", ticker),
         x = "", y = "Retorno") +
    theme(plot.title = element_text(face = "bold"))
}


# Modelagem e previsão de volatilidade CORRIGIDA
for (ticker in tickers) {
  returns <- log_returns[[ticker]][!is.na(log_returns[[ticker]])] %>% as.numeric()
  
  spec <- ugarchspec(
    variance.model = list(model = "sGARCH", garchOrder = c(1,1)),
    mean.model = list(armaOrder = c(0,0)),
    distribution.model = "std"
  )
  
  fit <- ugarchfit(spec, data = returns, solver = "hybrid")
  fore <- ugarchforecast(fit, n.ahead = 100)
  
  volatilidade <- sigma(fore) %>% as.numeric()
  datas <- seq(max(log_returns$date), by = "day", length.out = 100)
  
  plots_vol[[ticker]] <- ggplot(data.frame(Date = datas, Vol = volatilidade),
                              aes(x = Date, y = Vol)) +
    geom_line(color = "firebrick", linewidth = 0.8) +
    labs(title = paste("Previsão Volatilidade -", ticker),
         x = "", y = "Volatilidade") +
    theme(plot.title = element_text(face = "bold"))
}
```

## Retornos Diários {.tabset}

### SAP

```{r}
#| echo: false
plots_log$SAP
```

### ORACLE

```{r}
#| echo: false
plots_log$ORCL
```

### SALESFORCE

```{r}
#| echo: false
plots_log$CRM
```

### IBM

```{r}
#| echo: false
plots_log$IBM
```

### ServiceNOW

```{r}
#| echo: false
plots_log$NOW
```

## Previsão de Volatilidade {.tabset}

### SAP

```{r}
#| echo: false
plots_vol$SAP
```

### ORACLE

```{r}
#| echo: false 
plots_vol$ORCL
```

### SALESFORCE

```{r}
#| echo: false 
plots_vol$CRM
```

### IBM

```{r}
#| echo: false
plots_vol$IBM
```

### ServiceNOW

```{r}
#| echo: false
plots_vol$NOW
```
